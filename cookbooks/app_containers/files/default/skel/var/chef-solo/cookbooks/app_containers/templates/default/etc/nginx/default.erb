proxy_cache_path /var/www/nginx_cache/<%= @params[:server_name] %> levels=1:2 keys_zone=<%= @params[:server_name] %>:10m max_size=1g; 

server {
  listen 80;
  server_name <%= @params[:server_name] %> <% @params[:aliases].each do |a| -%><%= " #{a}" %><% end -%>;
  root <%= @params[:web_root]%>;

  access_log <%= @params[:home_dir] %>/var/log/nginx/access.log;
  access_log <%= @params[:home_dir] %>/var/log/nginx/cache-access.log cache;
  error_log <%= @params[:home_dir] %>/var/log/nginx/error.log;

  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header Host $host;
  proxy_pass_header Set-Cookie; # Let the Set-Cookie header through.
  proxy_cache <%= @params[:server_name] %>;
  proxy_cache_key $scheme$host$uri$is_args$args;
  proxy_cache_valid 30s; # 200, 301 and 302 will be cached.
  proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_504 http_404;

  # 2 rules to dedicate the no caching rule for logged in WP users.
  set $wordpress_auth "";  # Must be set to blank first for when they don't exist.
  if ($http_cookie ~* "wordpress_logged_in_[^=]*=([^%]+)%7C") {
    set $wordpress_auth wordpress_logged_in_$1;
  }
  proxy_cache_bypass $wordpress_auth; # Do not cache the response.
  proxy_no_cache $wordpress_auth; # Do not serve response from cache.
  
  #Serve static files directly without caching
  location ~* ^(/[_0-9a-zA-Z-]+)(/wp-.*\.(jpg|jpeg|gif|png|css|zip|pdf|txt|js|flv|swf|html|htm|ico))$  
  { # Extract filename in WPMU subfolder setup
    try_files $2 @apache_app_server;
  }
  location ~* ^.+\.(jpg|jpeg|gif|png|css|zip|pdf|txt|js|flv|swf|html|htm|ico)$
  {
    try_files $uri @apache_app_server;
  }
  location ~* ^/(wp-admin|wp-login.php)
  { # Don't cache wp-admin
    proxy_pass http://127.0.0.1:<%= @params[:port] %>;
  }
  location / {
    proxy_pass http://127.0.0.1:<%= @params[:port] %>;
  }
  location @apache_app_server {
    proxy_pass http://127.0.0.1:<%= @params[:port] %>;
  }
}